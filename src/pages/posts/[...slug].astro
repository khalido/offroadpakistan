---
import { getCollection, render } from "astro:content";
import BlogLayout from "../../layouts/BlogLayout.astro";
import CommentsList from "../../components/content/CommentsList.astro";

// Load all comments.json files at build time
const allCommentsModules = import.meta.glob(
    "/src/content/posts/**/comments.json",
);

export async function getStaticPaths() {
    const posts = await getCollection("posts", ({ data }) => !data.draft);
    return posts.map((post) => ({
        params: { slug: post.id },
        props: { post },
    }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// Find and load comments for the current post
let comments = [];
const commentPath = `/src/content/posts/${post.id}/comments.json`;
if (allCommentsModules[commentPath]) {
    const commentsModule = await allCommentsModules[commentPath]();
    comments = commentsModule.default?.comments || [];
}
---

<BlogLayout post={post}>
    <div class="prose">
        <Content />
    </div>

    <CommentsList comments={comments} />
</BlogLayout>
